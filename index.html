<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LLA. - Language Learning App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="selection:bg-purple-500 selection:text-white">

    <div id="app" class="flex flex-col">
    </div>

    <script>
        // --- Application State ---
        // ไม่ต้องใช้ API Key ของ Google ในหน้านี้แล้ว เพราะเราย้ายไปทำที่ Server Python หมดแล้ว
        const apiKey = ""; 

        let currentPage = 'welcome';
        let menuView = 'closed'; 
        let isLoading = false;
        let chatHistory = [
            { role: 'ai', text: 'สวัสดีครับ! ยินดีต้อนรับสู่ LLA. เรามาเริ่มฝึกพูดคุยภาษาอังกฤษกันเลยไหมครับ? (Hi! Welcome to LLA. Shall we start practicing English conversation?)' }
        ];
        let grammarSuggestion = null;
        let alphabetTab = 'consonants';
        
        // --- Audio/Recording State ---
        let isRecording = false;
        let audioStream = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let audioMimeType = null;
        let transcribedText = null;
        
        // --- Quiz State ---
        let quizLevel = null;
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let quizStatus = 'levelSelect';
        let showExplanation = false;
        let selectedAnswer = null;
        let randomizedOptions = []; 
        let error = null;

        // --- Alphabet Data ---
        const alphabetData = {
            consonants: [
                { th: 'ก', en: 'g' }, { th: 'ข', en: 'k' }, { th: 'ค', en: 'k' }, { th: 'ฆ', en: 'k' },
                { th: 'ง', en: 'ng' }, { th: 'จ', en: 'j' }, { th: 'ฉ', en: 'ch' }, { th: 'ช', en: 'ch' },
                { th: 'ซ', en: 's' }, { th: 'ฌ', en: 'ch' }, { th: 'ญ', en: 'y' }, { th: 'ฎ', en: 'd' },
                { th: 'ฏ', en: 'dt' }, { th: 'ฐ', en: 't' }, { th: 'ฑ', en: 't' }, { th: 'ฒ', en: 't' },
                { th: 'ณ', en: 'n' }, { th: 'ด', en: 'd' }, { th: 'ต', en: 'dt' }, { th: 'ถ', en: 't' },
                { th: 'ท', en: 't' }, { th: 'ธ', en: 't' }, { th: 'น', en: 'n' }, { th: 'บ', en: 'b' },
                { th: 'ป', en: 'bp' }, { th: 'ผ', en: 'p' }, { th: 'ฝ', en: 'f' }, { th: 'พ', en: 'p' },
                { th: 'ฟ', en: 'f' }, { th: 'ภ', en: 'p' }, { th: 'ม', en: 'm' }, { th: 'ย', en: 'y' },
                { th: 'ร', en: 'r' }, { th: 'ฤ', en: 'reu' }, { th: 'ฤา', en: 'reu' }, { th: 'ล', en: 'l' },
                { th: 'ฦ', en: 'leu' }, { th: 'ฦา', en: 'leu' }, { th: 'ว', en: 'w' }, { th: 'ศ', en: 's' },
                { th: 'ษ', en: 's' }, { th: 'ส', en: 's' }, { th: 'ห', en: 'h' }, { th: 'ฬ', en: 'l' },
                { th: 'อ', en: '-' }, { th: 'ฮ', en: 'h' }
            ],
            vowels: [
                { th: '-อ', en: '-or' }, { th: '-ะ', en: '-a' }, { th: '-ั', en: '-u' }, { th: '-ัว', en: '-oo-a' },
                { th: '-า', en: '-ah' }, { th: '-ำ', en: '-um' }, { th: '-ิ', en: '-i' }, { th: '-ี', en: '-ee' },
                { th: '-ึ', en: '-eu' }, { th: '-ื', en: '-eu' }, { th: '-ุ', en: '-oo' }, { th: '-ู', en: '-oo' },
                { th: 'เ-', en: '-ay' }, { th: 'เ-็', en: '-e' }, { th: 'เ-ย', en: '-er-ee' }, { th: 'เ-อะ', en: '-er' },
                { th: 'เ-ะ', en: '-e' }, { th: 'เ-า', en: '-aw' }, { th: 'เ-าะ', en: '-or' }, { th: 'เ-ิ', en: '-er' },
                { th: 'เ-ีย', en: '-ee-a' }, { th: 'เ-ียะ', en: '-ee-a' }, { th: 'เ-ือ', en: '-eu-a' }, { th: 'แ-', en: '-air' },
                { th: 'แ-็', en: '-air' }, { th: 'แ-ะ', en: '-air' }, { th: 'โ-', en: '-oh' }, { th: 'โ-ะ', en: '-o' },
                { th: 'ใ-', en: '-ai' }, { th: 'ไ-', en: '-ai' }
            ]
        };
        
        // --- Matching Game State ---
        let matchingQIndex = 0; 
        let matchingScore = 0;
        let matchingMaxQuestions = 20;
        let matchingCurrentQ = null;
        let matchingOptions = [];
        let matchingFeedback = null;
        let selectedMatchingAnswer = null; 
        let matchingStatus = 'playing';
        
        // --- Constants & Utilities ---
        const $app = document.getElementById('app');
        const startButtonStyle = "w-full h-14 rounded-full bg-white text-black font-bold text-lg shadow-[0_0_20px_rgba(255,255,255,0.3)] hover:shadow-[0_0_30px_rgba(255,255,255,0.5)] hover:scale-[1.02] transition-all active:scale-95 pointer-events-auto";

        function Icon(name, size = 20, className = "") {
            const iconName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
            return `<i data-lucide="${iconName}" width="${size}" height="${size}" class="${className}"></i>`;
        }
        
        const customAlert = (message) => {
            const alertBox = document.createElement('div');
            alertBox.className = 'fixed inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm z-[9999] animate-fade-in';
            alertBox.innerHTML = `
                <div class="glass-panel p-6 rounded-2xl max-w-sm w-full mx-4 text-center shadow-2xl transform scale-100">
                    <div class="w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4 text-red-400">
                        ${Icon('AlertCircle', 24)}
                    </div>
                    <h3 class="text-xl font-bold mb-2 text-white">แจ้งเตือน</h3>
                    <p class="text-sm text-gray-300 mb-6">${message}</p>
                    <button onclick="this.closest('.fixed').remove()" class="w-full py-3 rounded-xl bg-white/10 hover:bg-white/20 text-white font-medium transition-all">ปิด</button>
                </div>
            `;
            document.body.appendChild(alertBox);
        };
        
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        const blobToBase64 = (blob) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });

        async function fetchWithExponentialBackoff(url, options, maxRetries = 5) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    if (response.status === 429 || response.status >= 500) {
                        if (attempt < maxRetries - 1) {
                            await new Promise(r => setTimeout(r, Math.pow(2, attempt) * 1000));
                            continue;
                        }
                    }
                    throw new Error(`Status ${response.status}`);
                } catch (e) {
                    if (attempt === maxRetries - 1) throw e;
                    await new Promise(r => setTimeout(r, Math.pow(2, attempt) * 1000));
                }
            }
        }

        // ==========================================
        //  ฟังก์ชันหลักที่แก้ไขแล้ว: เชื่อมต่อ Python และเล่นเสียง
        // ==========================================
        const sendAudioMessage = async (audioBlob) => {
            if (isLoading) return;
            isLoading = true;
            transcribedText = '... กำลังส่งเสียงไปหา Kurisu (รอหน่อยนะ) ...';
            grammarSuggestion = null; 
            render(); 
            
            // ⚠️ URL ของ Python Server (ต้องรันไฟล์ server.py ก่อน)
            const apiUrl = `http://localhost:5000/chat`;
            
            try {
                // สร้าง FormData ส่งไฟล์เสียง
                const formData = new FormData();
                formData.append('audio', audioBlob, 'voice_input.webm');

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();
                
                // 1. รับข้อความตอบกลับ
                const aiResponseText = result.text || '(ไม่มีข้อความตอบกลับ)';
                
                // 2. [สำคัญ] รับไฟล์เสียงและเล่น
                if (result.audio) {
                    console.log("ได้รับไฟล์เสียงแล้ว กำลังจะเล่น...");
                    try {
                        const audio = new Audio("data:audio/wav;base64," + result.audio);
                        await audio.play();
                        console.log("กำลังเล่นเสียง...");
                    } catch (audioErr) {
                        console.error("Browser บล็อกเสียง หรือเล่นไม่ได้:", audioErr);
                    }
                } else {
                    console.log("Server ไม่ได้ส่งเสียงกลับมา");
                }

                // อัปเดตหน้าจอ
                chatHistory.push({ role: 'user', text: '(Voice Input Sent)', isVoice: true });
                chatHistory.push({ role: 'ai', text: aiResponseText });
                transcribedText = '(Voice Input Sent)';

            } catch (e) {
                transcribedText = null; 
                customAlert(`เกิดข้อผิดพลาด: ${e.message} (เช็คว่ารัน server.py หรือยัง?)`);
            } finally {
                isLoading = false;
                render();
                setTimeout(() => {
                    const chatBox = document.getElementById('chat-box');
                    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
                }, 50);
            }
        };

        const checkGrammar = async (textToCheck) => {
            if (isLoading || !textToCheck || textToCheck.includes('(Voice Input)')) return;
            isLoading = true;
            grammarSuggestion = null;
            render();

            // ฟังก์ชันนี้ยังใช้ Google API โดยตรง (ถ้าต้องการใช้)
            // คุณอาจต้องแก้ให้ยิงไปที่ Python Server แทนในอนาคตถ้าต้องการ
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const userQuery = `Analyze for grammar/spelling. Respond JSON: { "isPerfect": boolean, "correctedText": string, "feedback": [{ "errorType": string, "original": string, "correction": string, "explanationThai": string }] }. Text: "${textToCheck}"`;
            
            try {
                const response = await fetchWithExponentialBackoff(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: userQuery }] }], generationConfig: { responseMimeType: "application/json" } }) });
                const result = await response.json();
                grammarSuggestion = JSON.parse(result.candidates?.[0]?.content?.parts?.[0]?.text);
            } catch (e) {
                console.error(e);
                customAlert("ไม่สามารถตรวจสอบไวยากรณ์ได้ในขณะนี้");
            } finally {
                isLoading = false;
                render();
            }
        };

        const startQuiz = async (level) => {
            // ฟังก์ชันนี้ยังใช้ Google API โดยตรง
            if (isLoading) return;
            restartQuiz(false);
            quizLevel = level; quizQuestions = []; currentQuestionIndex = 0; score = 0; quizStatus = 'levelSelect'; isLoading = true; error = null;
            render();

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const userQuery = `Create 20 English multiple-choice questions (${level} level). Each question MUST have exactly 4 options. JSON Array: [{ "q": string, "options": [{"en": string, "th": string}], "correct": string, "explain": string (Thai) }]. Ensure the "correct" field matches the "en" text of one option exactly.`;

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: userQuery }] }], generationConfig: { responseMimeType: "application/json" } }) });
                const result = await response.json();
                quizQuestions = JSON.parse(result.candidates[0].content.parts[0].text);
                quizStatus = 'inProgress';
                randomizedOptions = shuffleArray(quizQuestions[currentQuestionIndex].options);
            } catch (e) {
                console.log(e);
                error = "ไม่สามารถโหลดแบบทดสอบได้ (API Key อาจจะหาย)";
                quizStatus = 'levelSelect';
            } finally {
                isLoading = false;
                render();
            }
        };

        // --- Matching Game Logic ---
        const startMatchingGame = () => {
            matchingQIndex = 0; 
            matchingScore = 0;
            matchingStatus = 'playing';
            nextMatchingQuestion();
            setCurrentPage('matching');
        };

        const nextMatchingQuestion = () => {
            if (matchingQIndex >= matchingMaxQuestions) {
                matchingStatus = 'finished';
                render();
                return;
            }
            matchingQIndex++; 
            const allItems = [...alphabetData.consonants, ...alphabetData.vowels];
            const randomIndex = Math.floor(Math.random() * allItems.length);
            matchingCurrentQ = allItems[randomIndex];
            
            const distractors = new Set();
            while(distractors.size < 3) {
                const r = Math.floor(Math.random() * allItems.length);
                const item = allItems[r];
                if (item.en !== matchingCurrentQ.en && item.en !== '-') {
                    distractors.add(item.en);
                }
            }
            matchingOptions = shuffleArray([matchingCurrentQ.en, ...Array.from(distractors)]);
            matchingFeedback = null;
            selectedMatchingAnswer = null; 
            render();
        };

        const submitMatchingAnswer = (ans) => {
            if (matchingFeedback) return;
            selectedMatchingAnswer = ans; 
            if (ans === matchingCurrentQ.en) {
                matchingScore++;
                matchingFeedback = 'correct';
            } else {
                matchingFeedback = 'incorrect';
            }
            render();
            setTimeout(() => {
                nextMatchingQuestion();
            }, 1200);
        };

        // --- Audio Recording Handlers ---
        const startRecording = async () => {
            if (isRecording || isLoading) return;
            grammarSuggestion = null;
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true } });
                const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/webm';
                audioMimeType = mimeType;
                mediaRecorder = new MediaRecorder(audioStream, { mimeType });
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: audioMimeType });
                    sendAudioMessage(audioBlob);
                    audioMimeType = null; mediaRecorder = null;
                };
                mediaRecorder.start();
                isRecording = true;
                render();
            } catch (e) { customAlert("ไม่สามารถเข้าถึงไมโครโฟนได้"); }
        };

        const stopRecording = () => {
            if (!isRecording || !mediaRecorder) return;
            mediaRecorder.stop();
            if (audioStream) audioStream.getTracks().forEach(t => t.stop());
            isRecording = false;
            render();
        };

        const toggleRecording = () => isRecording ? stopRecording() : startRecording();

        // --- Reset/Restart Quiz Logic ---
        const restartQuiz = (shouldRender = true) => {
            quizLevel = null;
            quizQuestions = [];
            currentQuestionIndex = 0;
            score = 0;
            quizStatus = 'levelSelect';
            showExplanation = false;
            selectedAnswer = null;
            randomizedOptions = [];
            error = null;
            if (shouldRender) render();
        };

        const goHome = () => { stopRecording(); menuView = 'closed'; currentPage = 'welcome'; chatHistory = [{ role: 'ai', text: 'สวัสดีครับ! ยินดีต้อนรับสู่ LLA. เรามาเริ่มฝึกพูดคุยภาษาอังกฤษกันเลยไหมครับ?' }]; grammarSuggestion = null; restartQuiz(false); render(); };
        const setCurrentPage = (page) => { stopRecording(); menuView = 'closed'; currentPage = page; grammarSuggestion = null; render(); };
        const toggleMenu = () => { menuView = menuView === 'closed' ? 'main' : 'closed'; render(); };
        const setMenuView = (view) => { menuView = view; render(); };
        const setAlphabetTab = (tab) => { alphabetTab = tab; render(); };
        const handleGrammarCheckClick = () => {
            const text = chatHistory.filter(msg => msg.role === 'user' && msg.isVoice).pop()?.text || transcribedText;
            if (text && !text.includes('(Voice Input)')) {
                checkGrammar(text);
            }
        };

        // --- Components ---
        const Logo = () => `
            <button onclick="goHome()" class="absolute top-6 left-6 md:top-10 md:left-10 group z-50 focus:outline-none select-none">
                <div class="flex flex-col items-start">
                    <span class="text-white font-bold text-2xl tracking-widest group-hover:text-purple-400 transition-colors font-sans">LLA.</span>
                    <div class="h-1 w-20 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full mt-1"></div>
                </div>
            </button>
        `;

        const CloseButton = () => `
            <button onclick="goHome()" class="absolute top-6 right-6 md:top-10 md:right-10 p-3 glass-button rounded-full text-gray-300 hover:text-white z-50 group select-none">
                ${Icon('X', 24, "group-hover:rotate-90 transition-transform duration-300")}
            </button>
        `;

        // Screen 1: Welcome
        const WelcomeScreen = () => {
            const startBtn = `<button onclick="setMenuView('main')" class="${startButtonStyle}">เริ่มต้นใช้งาน</button>`;
            const closeBtn = `<button onclick="setMenuView('closed')" class="${startButtonStyle} bg-white/10 backdrop-blur-md border border-white/20 hover:bg-white/20 text-white">ปิดเมนู</button>`;
            const backBtn = `<button onclick="setMenuView('main')" class="${startButtonStyle} bg-white/10 backdrop-blur-md border border-white/20 hover:bg-white/20 text-white flex items-center justify-center gap-2">${Icon('ArrowLeft', 20)} ย้อนกลับ</button>`;

            const MenuCard = (title, icon, onClick, subtitle = "") => `
                <button onclick="${onClick}" class="glass-panel p-6 rounded-3xl flex flex-col items-center justify-center gap-4 h-[400px] md:h-[450px] min-w-[85vw] md:min-w-0 md:w-full hover:bg-white/10 hover:border-indigo-500/50 transition-all group relative overflow-hidden border border-white/5 flex-shrink-0 snap-center select-none active:scale-95">
                    <div class="absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-purple-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="p-6 rounded-full bg-white/5 border border-white/10 text-white group-hover:scale-110 transition-transform shadow-lg group-hover:shadow-indigo-500/20 z-10">
                        ${Icon(icon, window.innerWidth < 768 ? 48 : 64)}
                    </div>
                    <div class="z-10 text-center">
                        <h3 class="text-2xl md:text-3xl font-bold text-white mb-2 md:mb-3 group-hover:text-transparent group-hover:bg-clip-text group-hover:bg-gradient-to-r group-hover:from-indigo-400 group-hover:to-purple-400 transition-all">${title}</h3>
                        ${subtitle ? `<p class="text-sm md:text-base text-gray-400 line-clamp-2 md:line-clamp-none">${subtitle}</p>` : ''}
                    </div>
                </button>
            `;

            const categoriesOverlay = `
                <div class="absolute inset-0 z-40 bg-black/50 backdrop-blur-xl flex flex-col items-center justify-center p-0 md:p-6 animate-fade-in">
                    <div class="w-full max-w-6xl h-full flex flex-col justify-center">
                        <h2 class="md:hidden text-2xl font-bold text-white mb-6 text-center px-4 mt-20">เลือกโหมดการใช้งาน</h2>
                        <div class="flex md:grid md:grid-cols-3 gap-6 md:gap-6 animate-fade-in-up overflow-x-auto md:overflow-visible snap-x snap-mandatory px-[7.5vw] md:px-0 pb-32 md:pb-0 no-scrollbar items-center h-full md:h-auto">
                            ${MenuCard('Talk AI', 'MessageSquare', "setCurrentPage('talk')", 'ฝึกสนทนากับ AI')}
                            ${MenuCard('Exercise', 'BookOpen', "setCurrentPage('exercise')", 'แบบทดสอบภาษาอังกฤษ')}
                            ${MenuCard('Alphabet', 'Type', "setMenuView('alphabet_sub')", 'เทียบอักษร & เกมจับคู่')}
                        </div>
                    </div>
                </div>
            `;

            const alphabetSubOverlay = `
                <div class="absolute inset-0 z-50 bg-black/50 backdrop-blur-xl flex flex-col items-center justify-center p-0 md:p-6 animate-fade-in">
                    <div class="w-full max-w-4xl h-full flex flex-col justify-center relative">
                        <h2 class="text-3xl md:text-4xl font-bold text-white mb-6 md:mb-12 drop-shadow-lg text-center px-4 mt-20 md:mt-0">เลือกโหมดเทียบตัวอักษร</h2>
                        <div class="flex md:grid md:grid-cols-2 gap-6 md:gap-8 animate-fade-in-up overflow-x-auto md:overflow-visible snap-x snap-mandatory px-[7.5vw] md:px-0 pb-32 md:pb-0 no-scrollbar items-center">
                            <button onclick="setCurrentPage('alphabet')" class="glass-panel p-8 md:p-12 rounded-[32px] flex flex-col items-center gap-6 md:gap-8 hover:border-pink-500/50 hover:bg-white/5 transition-all group h-[400px] md:h-[400px] min-w-[85vw] md:min-w-0 md:w-full flex-shrink-0 snap-center justify-center select-none active:scale-95">
                                <div class="p-6 md:p-8 rounded-full bg-pink-500/20 text-pink-300 group-hover:text-white group-hover:bg-pink-500 transition-all shadow-[0_0_30px_rgba(236,72,153,0.3)]">
                                    ${Icon('Table', window.innerWidth < 768 ? 40 : 56)}
                                </div>
                                <span class="text-xl md:text-2xl font-bold text-white">เทียบอักษรไทย-อังกฤษ</span>
                            </button>
                            <button onclick="startMatchingGame()" class="glass-panel p-8 md:p-12 rounded-[32px] flex flex-col items-center gap-6 md:gap-8 hover:border-emerald-500/50 hover:bg-white/5 transition-all group h-[400px] md:h-[400px] min-w-[85vw] md:min-w-0 md:w-full flex-shrink-0 snap-center justify-center select-none active:scale-95">
                                <div class="p-6 md:p-8 rounded-full bg-emerald-500/20 text-emerald-300 group-hover:text-white group-hover:bg-emerald-500 transition-all shadow-[0_0_30px_rgba(16,185,129,0.3)]">
                                    ${Icon('Crosshair', window.innerWidth < 768 ? 40 : 56)}
                                </div>
                                <span class="text-xl md:text-2xl font-bold text-white">Matching Game</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            return `
                <div class="flex flex-col items-center h-screen w-full relative overflow-hidden">
                    ${Logo()}
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] bg-purple-600/20 rounded-full blur-[120px] pointer-events-none"></div>
                    <div class="flex-1 flex items-center justify-center w-full pb-20 transition-all duration-700 ease-in-out ${menuView !== 'closed' ? 'opacity-30 blur-sm scale-95' : 'opacity-100 scale-100'}">
                        <h1 class="text-6xl md:text-8xl font-bold tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-white via-gray-200 to-gray-500 mb-12 text-center animate-fade-in-up select-none">Welcome</h1>
                    </div>
                    ${menuView === 'main' ? categoriesOverlay : ''}
                    ${menuView === 'alphabet_sub' ? alphabetSubOverlay : ''}
                    
                    <div class="absolute bottom-12 md:bottom-24 left-1/2 transform -translate-x-1/2 flex flex-col items-center w-full max-w-sm px-6 z-50 transition-all duration-300 pointer-events-none">
                        ${menuView === 'closed' ? startBtn : (menuView === 'main' ? closeBtn : (menuView === 'alphabet_sub' ? backBtn : ''))}
                    </div>
                </div>
            `;
        };

        const TalkScreen = () => {
            const checkGrammarText = chatHistory.filter(msg => msg.role === 'user' && msg.isVoice).pop()?.text || transcribedText;
            const isGrammarCheckReady = checkGrammarText && !isLoading && !isRecording && !checkGrammarText.includes('(Voice Input)');

            const messageBubbles = chatHistory.map((msg, idx) => {
                const isAI = msg.role === 'ai';
                const animateClass = idx === chatHistory.length - 1 ? 'animate-fade-in-up' : '';
                
                const suggestionHtml = (isAI && msg.suggestion) ? `
                    <div class="mt-3 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl text-sm backdrop-blur-sm">
                        <p class="font-bold text-yellow-400 flex items-center gap-2 mb-2">
                            ${Icon('Sparkles', 16)} คำแนะนำ (Suggestion)
                        </p>
                        ${msg.suggestion.split('|').map(part => `<p class="text-gray-300 mb-1 last:mb-0 leading-relaxed">${part.trim()}</p>`).join('')}
                    </div>
                ` : '';

                return `
                    <div class="flex ${isAI ? 'justify-start' : 'justify-end'} mb-6 ${animateClass}">
                        <div class="max-w-[85%] md:max-w-[75%]">
                            <div class="p-4 md:p-5 text-white leading-relaxed shadow-lg backdrop-blur-sm ${isAI ? 'ai-bubble text-gray-100' : 'user-bubble font-medium'}">
                                ${msg.isVoice ? `<span class="mr-2 inline-flex items-center justify-center w-6 h-6 bg-white/20 rounded-full text-xs">${Icon('Mic', 12)}</span>` : ''}
                                ${msg.text}
                            </div>
                            ${suggestionHtml}
                        </div>
                    </div>
                `;
            }).join('');

            const barsHtml = Array.from({ length: 20 }).map((_, i) => {
                const delay = (i * 0.05).toFixed(2);
                const h = Math.floor(Math.random() * 40) + 20; 
                return `<div class="vis-bar ${isRecording ? 'vis-bar-active' : ''}" style="${isRecording ? `animation-delay: ${delay}s; height: 40px;` : `height: ${h}px; opacity: 0.3;`} transform: scaleY(1);"></div>`;
            }).join('');

            return `
                <div class="flex flex-col h-screen w-full relative overflow-hidden">
                    ${Logo()} ${CloseButton()}

                    <div id="chat-box" class="flex-1 overflow-y-auto p-6 md:p-12 pt-24 pb-64 space-y-2 scroll-smooth">
                        ${messageBubbles}
                        ${isLoading ? `
                            <div class="flex justify-start mb-6 animate-fade-in">
                                <div class="ai-bubble p-4 flex items-center gap-3 text-gray-300">
                                    <div class="loader w-5 h-5 border-2 rounded-full"></div>
                                    <span>กำลังประมวลผล...</span>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    ${grammarSuggestion ? `
                        <div class="absolute bottom-[220px] left-4 right-4 md:left-auto md:right-8 md:w-96 glass-panel rounded-2xl p-5 animate-fade-in-up z-20 max-h-[60vh] overflow-y-auto border-l-4 border-l-blue-500">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-white flex items-center gap-2">${Icon('CheckCircle', 18, 'text-blue-400')} ผลการตรวจสอบ</h3>
                                <button onclick="grammarSuggestion=null; render()" class="text-gray-400 hover:text-white">${Icon('X', 16)}</button>
                            </div>
                            ${grammarSuggestion.isPerfect ? 
                                `<div class="text-green-400 bg-green-500/10 p-3 rounded-lg text-sm">ถูกต้องสมบูรณ์! ยอดเยี่ยมมาก</div>` : 
                                `<div class="space-y-3">
                                    <div class="bg-white/5 p-3 rounded-lg">
                                        <p class="text-xs text-gray-400">แก้ไขเป็น:</p>
                                        <p class="text-indigo-300 font-medium">${grammarSuggestion.correctedText}</p>
                                    </div>
                                    ${grammarSuggestion.feedback.map(f => `
                                        <div class="text-sm border-l-2 border-red-500 pl-3">
                                            <div class="flex gap-2 mb-1"><span class="text-red-400 line-through opacity-70">${f.original}</span> <span class="text-green-400">${f.correction}</span></div>
                                            <p class="text-xs text-gray-400">${f.explanationThai}</p>
                                        </div>
                                    `).join('')}
                                </div>`
                            }
                        </div>
                    ` : ''}

                    <div class="absolute bottom-0 w-full glass-panel border-t border-t-white/10 rounded-t-3xl p-6 pb-8 z-10 flex flex-col items-center shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
                        <div class="w-full flex flex-col items-center mb-4">
                            <div class="flex items-center justify-center gap-1 h-16 mb-1 w-full max-w-xs">
                                ${barsHtml}
                            </div>
                            <p class="text-sm font-medium ${isRecording ? 'text-red-400 animate-pulse' : 'text-gray-400'}">
                                ${isRecording ? '● กำลังฟัง... พูดได้เลย' : 'แตะไมค์เพื่อเริ่มสนทนา'}
                            </p>
                        </div>

                        <div class="flex items-center justify-center gap-6 w-full max-w-md relative mb-4">
                            <button 
                                onclick="${isGrammarCheckReady ? `handleGrammarCheckClick()` : ''}"
                                class="absolute left-4 md:left-0 p-3 rounded-full transition-all ${isGrammarCheckReady ? 'bg-white/10 text-yellow-400 hover:bg-white/20' : 'opacity-30 cursor-not-allowed'}"
                                title="ตรวจสอบไวยากรณ์"
                            >
                                ${Icon('Sparkles', 22)}
                            </button>

                            <button 
                                onclick="toggleRecording()"
                                class="w-20 h-20 rounded-full flex items-center justify-center transition-all duration-300 ${isRecording ? 'bg-red-500 shadow-[0_0_30px_rgba(239,68,68,0.6)] scale-110' : 'bg-gradient-to-br from-indigo-500 to-purple-600 shadow-[0_0_20px_rgba(99,102,241,0.5)] hover:scale-105'}"
                            >
                                ${Icon(isRecording ? 'Square' : 'Mic', 36, "text-white")}
                            </button>

                            <div class="w-12"></div>
                        </div>
                        
                        <div class="w-full max-w-xs px-2">
                            <button onclick="goHome()" class="${startButtonStyle}">
                                สิ้นสุดการสนทนา
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const ExerciseScreen = () => {
            let content;
            const shouldCenter = (quizStatus === 'levelSelect' && window.innerWidth >= 768) || quizStatus === 'finished';
            const isLevelSelectMobile = quizStatus === 'levelSelect' && window.innerWidth < 768;

            if (isLoading) {
                content = `<div class="text-center animate-fade-in-up"><div class="loader w-12 h-12 border-4 rounded-full mb-6 mx-auto"></div><h2 class="text-2xl font-bold text-white mb-2">กำลังสร้างโจทย์...</h2><p class="text-gray-400">รอสักครู่ ระบบกำลังเตรียมแบบฝึกหัดให้คุณ (20 ข้อ)</p></div>`;
            } else if (quizStatus === 'levelSelect') {
                const levels = [
                    { 
                        id: 'easy', 
                        name: 'ระดับเริ่มต้น (Beginner)', 
                        desc: 'เหมาะสำหรับผู้เริ่มต้น เรียนรู้คำศัพท์และประโยคพื้นฐาน', 
                        color: 'emerald', 
                        icon: 'Feather' 
                    },
                    { 
                        id: 'medium', 
                        name: 'ระดับกลาง (Intermediate)', 
                        desc: 'ท้าทายขึ้นด้วยไวยากรณ์และรูปประโยคที่ซับซ้อน', 
                        color: 'amber', 
                        icon: 'Zap' 
                    },
                    { 
                        id: 'hard', 
                        name: 'ระดับสูง (Advanced)', 
                        desc: 'สำหรับผู้เชี่ยวชาญ คำศัพท์เฉพาะทางและบทความยาว', 
                        color: 'rose', 
                        icon: 'Crown' 
                    }
                ];
                
                const getStyles = (color) => {
                    const colors = {
                        emerald: { bg: 'from-emerald-500/10 to-teal-500/10 hover:from-emerald-500/20 hover:to-teal-500/20', border: 'border-emerald-500/20 hover:border-emerald-400/50', icon: 'text-emerald-400', glow: 'shadow-emerald-500/10' },
                        amber: { bg: 'from-amber-500/10 to-orange-500/10 hover:from-amber-500/20 hover:to-orange-500/20', border: 'border-amber-500/20 hover:border-amber-400/50', icon: 'text-amber-400', glow: 'shadow-amber-500/10' },
                        rose: { bg: 'from-rose-500/10 to-red-500/10 hover:from-rose-500/20 hover:to-red-500/20', border: 'border-rose-500/20 hover:border-rose-400/50', icon: 'text-rose-400', glow: 'shadow-rose-500/10' }
                    };
                    return colors[color];
                };
                
                content = `
                    <div class="w-full max-w-6xl mx-auto md:px-6 flex flex-col items-center h-full justify-center">
                        <div class="text-center mb-8 md:mb-16 animate-fade-in-up px-6 mt-8 md:mt-0">
                            <h2 class="text-3xl md:text-6xl font-bold mb-4 md:mb-6 text-transparent bg-clip-text bg-gradient-to-b from-white via-white to-white/50 tracking-tight">Level Selection</h2>
                            <p class="text-gray-400 text-sm md:text-lg max-w-xl mx-auto">เลือกระดับความยากที่เหมาะสมกับคุณเพื่อเริ่มการทดสอบวัดผลทางภาษา</p>
                        </div>
                        
                        <div class="flex md:grid md:grid-cols-3 gap-4 md:gap-8 w-full overflow-x-auto md:overflow-visible snap-x snap-mandatory px-[7.5vw] md:px-0 pb-8 md:pb-0 no-scrollbar items-center">
                            ${levels.map((l, index) => {
                                const s = getStyles(l.color);
                                return `
                                <button onclick="startQuiz('${l.id}')" 
                                    class="group relative h-[520px] md:h-[420px] rounded-[32px] border ${s.border} bg-gradient-to-br ${s.bg} backdrop-blur-md p-8 flex flex-col justify-between text-left transition-all duration-500 hover:scale-[1.02] hover:shadow-2xl ${s.glow} animate-fade-in-up overflow-hidden min-w-[85vw] md:min-w-0 md:w-full flex-shrink-0 snap-center active:scale-95"
                                    style="animation-delay: ${index * 100}ms">
                                    
                                    <div class="absolute right-6 top-6 opacity-10 group-hover:opacity-20 transition-all duration-700 group-hover:rotate-12 group-hover:scale-110 ${s.icon}">
                                        ${Icon(l.icon, window.innerWidth < 768 ? 180 : 240)}
                                    </div>
                                    
                                    <div class="relative z-10">
                                        <div class="w-16 h-16 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center mb-8 backdrop-blur-xl group-hover:scale-110 transition-transform duration-500 ${s.icon} shadow-lg">
                                            ${Icon(l.icon, 32)}
                                        </div>
                                        
                                        <h3 class="text-3xl md:text-3xl font-bold text-white mb-4 group-hover:text-white transition-colors">${l.name}</h3>
                                        <p class="text-gray-400 text-base leading-relaxed opacity-80 group-hover:opacity-100 transition-opacity">
                                            ${l.desc}
                                        </p>
                                    </div>

                                    <div class="relative z-10 mt-auto pt-8 ${s.icon}">
                                        <div class="flex items-center gap-3 text-sm font-bold uppercase tracking-wider opacity-70 group-hover:opacity-100 group-hover:gap-5 transition-all duration-300">
                                            <span>Start Quiz</span>
                                            ${Icon('ArrowRight', 20)}
                                        </div>
                                        <div class="w-full h-1 bg-white/20 mt-4 rounded-full overflow-hidden">
                                            <div class="h-full w-0 bg-current opacity-75 group-hover:w-full transition-all duration-700 ease-out"></div>
                                        </div>
                                    </div>
                                </button>`;
                            }).join('')}
                        </div>
                        ${error ? `<div class="mt-8 p-4 bg-red-500/10 border border-red-500/20 rounded-2xl text-red-300 flex items-center gap-3 animate-fade-in">${Icon('AlertCircle', 20)} ${error}</div>` : ''}
                    </div>
                `;
            } else if (quizStatus === 'inProgress') {
                const qData = quizQuestions[currentQuestionIndex];
                const progress = ((currentQuestionIndex + 1) / quizQuestions.length) * 100;
                const optionsHtml = randomizedOptions.map(option => {
                    const encoded = encodeURIComponent(option.en).replace(/'/g, "%27");
                    let optionClasses = "w-full text-left p-4 mb-3 flex items-center justify-between transition-all rounded-xl text-white font-medium";
                    if (showExplanation) {
                        optionClasses += " cursor-default border";
                        if (option.en === qData.correct) optionClasses += " bg-green-900/30 border-green-500"; 
                        else if (option.en === selectedAnswer) optionClasses += " bg-red-900/30 border-red-500"; 
                        else optionClasses += " bg-zinc-800 border-transparent opacity-40"; 
                    } else {
                        optionClasses += " bg-zinc-800 border border-white/5 hover:bg-zinc-700 hover:border-white/20";
                    }
                    return `<button onclick="submitAnswer(decodeURIComponent('${encoded}'))" ${showExplanation ? 'disabled' : ''} class="${optionClasses}"><div class="flex flex-col md:flex-row md:items-center gap-1"><span class="text-base font-medium">${option.en}</span>${showExplanation ? `<span class="text-sm text-gray-400 font-sarabun">(${option.th})</span>` : ''}</div></button>`;
                }).join('');

                content = `
                    <div class="w-full max-w-xl mx-auto px-4">
                        <div class="w-full h-1.5 bg-gray-800 rounded-full mb-8 overflow-hidden"><div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-500" style="width: ${progress}%"></div></div>
                        <div class="exercise-card p-6 md:p-8 animate-fade-in-up mb-8">
                            <div class="flex justify-between items-center mb-8"><span class="text-xs font-bold tracking-wider text-gray-500 uppercase">QUESTION ${currentQuestionIndex + 1} OF ${quizQuestions.length}</span><span class="px-3 py-1 rounded-full bg-white/10 text-xs text-gray-300">${quizLevel === 'easy' ? 'เริ่มต้น' : quizLevel === 'medium' ? 'กลาง' : 'สูง'}</span></div>
                            <h3 class="text-2xl md:text-3xl font-bold text-white mb-8 leading-tight">${qData.q}</h3>
                            <div class="space-y-3">${optionsHtml}</div>
                            ${showExplanation ? `<div class="mt-6 p-5 bg-indigo-500/10 border border-indigo-500/30 rounded-2xl animate-fade-in"><p class="text-indigo-300 text-sm mb-4">${qData.explain}</p><button onclick="nextQuestion()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl text-white font-bold shadow-lg shadow-indigo-500/30 transition-all">${currentQuestionIndex < quizQuestions.length - 1 ? 'ข้อถัดไป' : 'ดูผลลัพธ์'}</button></div>` : ''}
                        </div>
                        <div class="h-16"></div> 
                    </div>
                `;
            } else if (quizStatus === 'finished') {
                const percentage = (score / quizQuestions.length) * 100;
                content = `
                    <div class="glass-panel p-8 md:p-12 rounded-3xl text-center max-w-sm mx-auto animate-fade-in-up shadow-2xl border-t border-white/10">
                        <div class="w-24 h-24 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center mx-auto mb-6 shadow-[0_0_40px_rgba(139,92,246,0.4)]"><span class="text-4xl font-bold text-white">${score}</span></div>
                        <h2 class="text-2xl font-bold text-white mb-2">สรุปผลลัพธ์</h2>
                        <p class="text-gray-400 mb-4">คุณทำได้ ${percentage.toFixed(0)}% (${score}/${quizQuestions.length})</p>
                        <div class="space-y-3"><button onclick="restartQuiz()" class="w-full py-3 bg-white text-black font-bold rounded-xl hover:scale-[1.02] transition-transform">ทำอีกครั้ง</button><button onclick="goHome()" class="w-full py-3 text-gray-400 hover:text-white transition-colors">กลับหน้าหลัก</button></div>
                    </div>
                `;
            }

            return `
                <div class="flex flex-col items-center min-h-screen w-full relative bg-[#0f0f11]">
                    ${Logo()} ${CloseButton()}
                    <div class="flex-1 w-full flex flex-col items-center py-8 pt-24 ${shouldCenter ? 'justify-center' : 'justify-start'} ${isLevelSelectMobile ? 'px-0' : 'px-4'}">
                        ${content}
                    </div>
                </div>
            `;
        };
        
        const AlphabetScreen = () => {
            const currentData = alphabetTab === 'consonants' ? alphabetData.consonants : alphabetData.vowels;
            return `
                <div class="flex flex-col items-center min-h-screen w-full relative bg-[#0f0f11]">
                    ${Logo()} ${CloseButton()}
                    <div class="flex-1 w-full max-w-5xl mx-auto px-4 pt-24 pb-12">
                        <div class="text-center mb-8 animate-fade-in-up">
                            <h2 class="text-3xl md:text-4xl font-bold text-white mb-2 font-sarabun">การเทียบอักษร ไทย - อังกฤษ</h2>
                            <p class="text-gray-400">Mapping Thai Alphabet to English Sounds</p>
                        </div>
                        <div class="flex justify-center mb-8 animate-fade-in-up" style="animation-delay: 0.1s;">
                            <div class="bg-zinc-800/50 p-1 rounded-full flex gap-1 border border-white/5">
                                <button onclick="setAlphabetTab('consonants')" class="px-6 py-2 rounded-full text-sm font-bold transition-all ${alphabetTab === 'consonants' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30' : 'text-gray-400 hover:text-white hover:bg-white/5'}">พยัญชนะ (Consonants)</button>
                                <button onclick="setAlphabetTab('vowels')" class="px-6 py-2 rounded-full text-sm font-bold transition-all ${alphabetTab === 'vowels' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30' : 'text-gray-400 hover:text-white hover:bg-white/5'}">สระ (Vowels)</button>
                            </div>
                        </div>
                        <div class="alphabet-grid animate-fade-in-up" style="animation-delay: 0.2s;">
                            ${currentData.map((item, idx) => `
                                <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center aspect-square border-t border-white/10 hover:border-indigo-500/50 transition-all hover:bg-white/10 group cursor-default">
                                    <span class="text-2xl md:text-4xl font-bold text-white mb-1 group-hover:scale-110 transition-transform font-sarabun">${item.th}</span>
                                    <span class="text-xs md:text-base text-indigo-300 font-medium">${item.en}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        };

        const MatchingScreen = () => {
            if (matchingStatus === 'finished') {
                return `
                    <div class="flex flex-col items-center min-h-screen w-full relative bg-[#0f0f11]">
                        ${Logo()} ${CloseButton()}
                        <div class="flex-1 w-full flex flex-col items-center justify-center p-6">
                            <div class="glass-panel p-8 md:p-12 rounded-3xl text-center max-w-sm mx-auto animate-fade-in-up shadow-2xl border-t border-white/10">
                                <div class="w-24 h-24 rounded-full bg-gradient-to-tr from-emerald-500 to-teal-500 flex items-center justify-center mx-auto mb-6 shadow-[0_0_40px_rgba(16,185,129,0.4)]"><span class="text-4xl font-bold text-white">${matchingScore}</span></div>
                                <h2 class="text-2xl font-bold text-white mb-2">สรุปผลคะแนน</h2>
                                <p class="text-gray-400 mb-4">คะแนนของคุณ: ${matchingScore} / ${matchingMaxQuestions}</p>
                                <div class="space-y-3"><button onclick="startMatchingGame()" class="w-full py-3 bg-white text-black font-bold rounded-xl hover:scale-[1.02] transition-transform shadow-lg">เล่นอีกครั้ง</button><button onclick="goHome()" class="w-full py-3 text-gray-400 hover:text-white transition-colors">กลับหน้าหลัก</button></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            if (!matchingCurrentQ) return '';
            return `
                <div class="flex flex-col items-center min-h-screen w-full relative bg-[#0f0f11]">
                    ${Logo()} 
                    <div class="flex-1 w-full max-w-xl mx-auto px-4 pt-24 pb-12 flex flex-col items-center justify-center">
                        <div class="text-center mb-10 animate-fade-in-up">
                            <h2 class="text-3xl font-bold text-white mb-2">จับคู่ตัวอักษร</h2>
                            <p class="text-gray-400">เลือกคำอ่านภาษาอังกฤษที่ถูกต้อง (ข้อที่: ${matchingQIndex}/${matchingMaxQuestions})</p>
                        </div>
                        <div class="glass-panel w-40 h-40 md:w-48 md:h-48 rounded-3xl flex items-center justify-center mb-8 md:mb-12 border-2 border-indigo-500/30 shadow-[0_0_50px_rgba(99,102,241,0.2)] animate-pulse-slow">
                            <span class="text-6xl md:text-8xl font-bold text-white font-sarabun whitespace-nowrap">${matchingCurrentQ.th}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4 w-full">
                            ${matchingOptions.map(opt => {
                                let btnClass = "py-4 md:py-6 rounded-xl text-xl md:text-2xl font-bold transition-all border-2 ";
                                if (matchingFeedback) {
                                    if (opt === matchingCurrentQ.en) btnClass += "bg-green-600/30 border-green-500 text-white scale-105 shadow-[0_0_20px_rgba(34,197,94,0.4)]";
                                    else if (opt === selectedMatchingAnswer) btnClass += "bg-red-600/30 border-red-500 text-white opacity-80";
                                    else btnClass += "bg-zinc-800/50 border-transparent text-gray-500 opacity-30";
                                } else {
                                    btnClass += "bg-white/5 border-white/10 text-white hover:bg-white/10 hover:border-indigo-500 hover:text-indigo-300 hover:shadow-lg active:scale-95";
                                }
                                return `<button onclick="${!matchingFeedback ? `submitMatchingAnswer('${opt}')` : ''}" class="${btnClass}">${opt}</button>`;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        };

        function render() {
            let htmlContent = '';
            switch (currentPage) {
                case 'welcome': htmlContent = WelcomeScreen(); break;
                case 'talk': htmlContent = TalkScreen(); break;
                case 'exercise': htmlContent = ExerciseScreen(); break;
                case 'alphabet': htmlContent = AlphabetScreen(); break;
                case 'matching': htmlContent = MatchingScreen(); break;
                default: htmlContent = WelcomeScreen();
            }
            $app.innerHTML = htmlContent;
            if (window.lucide) try { window.lucide.createIcons(); } catch(e) {}
            if (currentPage === 'talk') {
                const chatBox = document.getElementById('chat-box');
                if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
            }
        }
        
        const submitAnswer = (ans) => { 
            if(!showExplanation) { 
                selectedAnswer = ans; 
                showExplanation = true; 
                if(ans === quizQuestions[currentQuestionIndex].correct) score++; 
                render(); 
                setTimeout(() => { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }, 50);
            }
        };

        const nextQuestion = () => { 
            selectedAnswer = null; showExplanation = false; 
            if(currentQuestionIndex < quizQuestions.length - 1) { 
                currentQuestionIndex++; randomizedOptions = shuffleArray(quizQuestions[currentQuestionIndex].options); 
                render(); 
                setTimeout(() => { window.scrollTo({ top: 0, behavior: 'smooth' }); }, 50);
            } else { quizStatus = 'finished'; render(); }
        };

        document.addEventListener('DOMContentLoaded', render);
    </script>
</body>
</html>